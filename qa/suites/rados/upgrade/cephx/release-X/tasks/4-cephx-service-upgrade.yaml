tasks:
- ceph.key_rotate:
    daemons: [mon.*]
    key_type: aes256k
- ceph.key_rotate:
    daemons: [mgr.*, osd.*, mds.*]
    key_type: aes256k
- exec:
    mon.a:
      - ceph --debug_ms=5 --debug_auth=30 --debug_monc=30 auth ls
      - ceph --debug_ms=5 --debug_auth=30 --debug_monc=30 auth --format=json-pretty dump-keys
      - ceph --debug_ms=5 --debug_auth=30 --debug_monc=30 auth --format=json dump-keys | jq 'any(.data.secrets[] | select(.entity.type == 1 or .entity.type == 2 or .entity.type == 4 or .entity.type == 16); .auth.key.type != 2)'
      - ceph --debug_ms=5 --debug_auth=30 --debug_monc=30 auth --format=json dump-keys | jq '.data.rotating_secrets | all( .secrets.keys | all(.expiring_key.key.type == 1) )'
      - ceph --debug_ms=5 --debug_auth=30 --debug_monc=30 mon set auth_service_cipher aes256k
